---
import MainLayout from '@/layouts/MainLayout.astro';
import ArticleView from '@/views/pages/ArticleView';
import { getAllArticles } from '@/lib/articles';

export async function getStaticPaths() {
  const articles = await getAllArticles();
  return articles.map((article) => ({
    params: { slug: article.slug },
    props: { article },
  }));
}

const { article } = Astro.props;

if (!article) {
  return Astro.redirect('/404');
}

const title = `${article.title} | RS Avukatlık`;
const description = article.excerpt || "Hukuki makale";
const canonical = `https://www.rsavukatlik.com/makalelerimiz/${article.slug}`;

// Authority Wheel: Get related articles for interlinking
const allArticles = await getAllArticles();
const relatedArticles = allArticles
  .filter(a => a.category === article.category && a.slug !== article.slug)
  .slice(0, 3); // Get up to 3 related articles


// Helper to convert Turkish date string to ISO format for Schema
const getIsoDate = (dateStr: string) => {
    try {
        return new Date(dateStr).toISOString().split('T')[0];
    } catch (e) {
        return new Date().toISOString().split('T')[0];
    }
};

const schema = [
    {
        "@context": "https://schema.org",
        "@type": "BreadcrumbList",
        "itemListElement": [
            {
                "@type": "ListItem",
                "position": 1,
                "name": "Ana Sayfa",
                "item": "https://www.rsavukatlik.com/"
            },
            {
                "@type": "ListItem",
                "position": 2,
                "name": "Makalelerimiz",
                "item": "https://www.rsavukatlik.com/makalelerimiz"
            },
            {
                "@type": "ListItem",
                "position": 3,
                "name": article.title,
                "item": canonical
            }
        ]
    },
    {
        "@context": "https://schema.org",
        "@type": "Article",
        "headline": article.title,
        "description": article.excerpt,
        "image": "https://www.rsavukatlik.com/og-image.jpg", // TODO: Add logic for article image if available
        "author": {
            "@type": "Person",
            "name": "Av. Ramazan Şimşek",
            "url": "https://www.rsavukatlik.com",
            "sameAs": [
                "https://www.instagram.com/av.ramazansimsek",
                "https://www.linkedin.com/in/ramazan-%C5%9Fim%C5%9Fek"
            ]
        },
        "publisher": {
            "@type": "Organization",
            "name": "RS Avukatlık",
            "logo": {
                "@type": "ImageObject",
                "url": "https://www.rsavukatlik.com/logo.webp"
            }
        },
        "datePublished": getIsoDate(article.date),
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": canonical
        }
    }
];
---

<MainLayout title={title} description={description} canonical={canonical} schema={schema}>
  <ArticleView client:load article={article} relatedArticles={relatedArticles} />
</MainLayout>
